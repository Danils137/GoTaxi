# 🚗 Алгоритм подбора водителей и ценообразования GoTaxi

## 🎯 Концепция системы

### **Основные принципы:**
- **Индивидуальные тарифы** - у каждого водителя свой уникальный тариф
- **Динамическое ценообразование** - тарифы могут изменяться от спроса/предложения
- **Ручное управление** - водитель может корректировать тарифы самостоятельно
- **Прозрачность** - клиент видит все варианты и выбирает оптимальный

## 📊 Сценарии подбора водителей

### **Сценарий 1: Обычная ситуация**
```
Клиент заказывает поездку:
📍 От: Центр Риги
📍 До: Аэропорт Рига
🕐 Время: 14:00 (будний день)
📏 Расстояние: 12 км
⏱️ Время в пути: 18 минут
```

**Доступные водители в радиусе 5 км:**

| Водитель | Расстояние | Базовый тариф | €/км | €/мин | Итого | Рейтинг | ETA |
|----------|------------|---------------|------|-------|-------|---------|-----|
| Андрей   | 1.2 км     | €2.50        | €1.20| €0.30 | €19.90| 4.8⭐   | 3 мин |
| Мария    | 2.1 км     | €2.00        | €1.00| €0.25 | €18.50| 4.9⭐   | 5 мин |
| Петр     | 0.8 км     | €3.00        | €1.50| €0.35 | €24.30| 4.6⭐   | 2 мин |
| Елена    | 3.2 км     | €2.20        | €1.10| €0.28 | €19.44| 4.7⭐   | 7 мин |

**Алгоритм сортировки:**
1. **Фильтрация** - только доступные водители в радиусе
2. **Расчет стоимости** - для каждого водителя
3. **Сортировка** - по комбинированному рейтингу
4. **Топ-3 варианта** - показать клиенту

### **Сценарий 2: Час пик**
```
Клиент заказывает поездку:
📍 От: Офисный район
📍 До: Жилой район
🕐 Время: 18:00 (час пик)
📏 Расстояние: 8 км
⏱️ Время в пути: 25 минут (пробки)
```

**Динамические изменения:**
- **Спрос высокий** → автоматическое увеличение тарифов на 20-50%
- **Мало водителей** → приоритет ближайшим
- **Пробки** → увеличение времени в пути

| Водитель | Базовый тариф | Множитель | €/км | €/мин | Итого | Статус |
|----------|---------------|-----------|------|-------|-------|--------|
| Игорь    | €2.50        | x1.3      | €1.56| €0.39 | €22.95| 🔥 Популярный |
| Анна     | €2.00        | x1.2      | €1.20| €0.30 | €19.90| ⚡ Быстрый |
| Олег     | €3.00        | x1.0      | €1.50| €0.35 | €23.75| 💎 Премиум |

### **Сценарий 3: Ночное время**
```
Клиент заказывает поездку:
📍 От: Центр города
📍 До: Пригород
🕐 Время: 02:00 (ночь)
📏 Расстояние: 15 км
⏱️ Время в пути: 20 минут
```

**Ночные особенности:**
- **Ночная надбавка** - автоматически добавляется
- **Меньше водителей** - ограниченный выбор
- **Безопасность** - приоритет проверенным водителям

| Водитель | Базовый | Ночная надбавка | €/км | €/мин | Итого | Опыт |
|----------|---------|-----------------|------|-------|-------|------|
| Сергей   | €2.50   | +€0.50/км      | €1.70| €0.30 | €33.00| 5 лет |
| Дмитрий  | €2.00   | +€0.50/км      | €1.50| €0.25 | €30.50| 3 года |

### **Сценарий 4: Аэропорт**
```
Клиент заказывает поездку:
📍 От: Аэропорт Рига
📍 До: Центр города
🕐 Время: 10:00
📏 Расстояние: 12 км
⏱️ Время в пути: 18 минут
```

**Аэропортные особенности:**
- **Надбавка за аэропорт** - €2.00 фиксированно
- **Лицензированные водители** - только с разрешением на аэропорт
- **Очередь** - система FIFO для справедливости

| Водитель | Базовый | Аэропорт | €/км | €/мин | Итого | Лицензия |
|----------|---------|----------|------|-------|-------|----------|
| Алексей  | €2.50   | +€2.00   | €1.20| €0.30 | €21.90| ✅ AD-2024 |
| Виктор   | €2.20   | +€2.00   | €1.10| €0.28 | €20.44| ✅ AD-2023 |

## 🧮 Формула расчета стоимости

### **Базовая формула:**
```javascript
totalCost = baseFare + (distance * pricePerKm) + (timeInMinutes * pricePerMinute) + surcharges

где:
- baseFare: базовый тариф водителя (посадка)
- distance: расстояние поездки в км
- pricePerKm: цена за километр водителя
- timeInMinutes: время поездки в минутах
- pricePerMinute: цена за минуту водителя
- surcharges: надбавки (ночь, выходные, аэропорт)
```

### **Надбавки:**
```javascript
surcharges = nightSurcharge + weekendSurcharge + airportSurcharge + demandMultiplier

nightSurcharge = isNightTime ? (distance * driver.nightSurcharge) : 0
weekendSurcharge = isWeekend ? (distance * driver.weekendSurcharge) : 0
airportSurcharge = (isAirportPickup || isAirportDropoff) ? driver.airportSurcharge : 0
demandMultiplier = baseCost * (demandLevel - 1.0)
```

### **Динамический множитель спроса:**
```javascript
demandLevel = calculateDemandLevel({
  activeRides: currentActiveRides,
  availableDrivers: nearbyDriversCount,
  timeOfDay: currentHour,
  dayOfWeek: currentDay,
  weather: weatherConditions,
  events: localEvents
})

// Примеры множителей:
// 1.0 = обычная ситуация
// 1.2 = небольшой спрос
// 1.5 = высокий спрос
// 2.0 = очень высокий спрос (редко)
```

## 🎯 Алгоритм подбора водителей

### **Шаг 1: Фильтрация доступных водителей**
```javascript
availableDrivers = drivers.filter(driver => {
  return driver.isOnline &&
         driver.isAvailable &&
         driver.distanceFromPickup <= MAX_PICKUP_DISTANCE &&
         driver.tariff.isApproved &&
         driver.hasRequiredLicenses(pickup, dropoff)
})
```

### **Шаг 2: Расчет стоимости для каждого водителя**
```javascript
driversWithCost = availableDrivers.map(driver => {
  const cost = calculateTripCost(driver, route, timeOfDay)
  const eta = calculateETA(driver.location, pickup)
  
  return {
    ...driver,
    estimatedCost: cost,
    estimatedArrival: eta,
    score: calculateDriverScore(driver, cost, eta)
  }
})
```

### **Шаг 3: Система скоринга водителей**
```javascript
function calculateDriverScore(driver, cost, eta) {
  const priceScore = (1 / cost) * 100          // Чем дешевле, тем лучше
  const speedScore = (1 / eta) * 50            // Чем быстрее, тем лучше
  const ratingScore = driver.rating * 20       // Рейтинг водителя
  const experienceScore = Math.min(driver.tripsCount / 100, 1) * 10
  
  return priceScore + speedScore + ratingScore + experienceScore
}
```

### **Шаг 4: Сортировка и группировка**
```javascript
// Сортировка по комбинированному скору
driversWithCost.sort((a, b) => b.score - a.score)

// Группировка по категориям
const options = {
  economy: driversWithCost.filter(d => d.estimatedCost <= averageCost * 0.9),
  standard: driversWithCost.filter(d => d.estimatedCost <= averageCost * 1.1),
  premium: driversWithCost.filter(d => d.rating >= 4.7),
  fastest: driversWithCost.sort((a, b) => a.estimatedArrival - b.estimatedArrival).slice(0, 3)
}
```

## 📱 Отображение вариантов клиенту

### **Интерфейс выбора:**
```
┌─────────────────────────────────────┐
│ 🚗 Доступные варианты поездки       │
├─────────────────────────────────────┤
│ 💰 ЭКОНОМ                          │
│ Мария • 4.9⭐ • Toyota Corolla      │
│ €18.50 • Прибытие: 5 мин           │
│ ├─ Базовый тариф: €2.00            │
│ ├─ За расстояние: €12.00           │
│ ├─ За время: €4.50                 │
│ └─ Надбавки: €0.00                 │
├─────────────────────────────────────┤
│ ⚡ БЫСТРЫЙ                          │
│ Андрей • 4.8⭐ • Skoda Octavia      │
│ €19.90 • Прибытие: 3 мин           │
├─────────────────────────────────────┤
│ 💎 ПРЕМИУМ                         │
│ Петр • 4.6⭐ • Mercedes E-Class     │
│ €24.30 • Прибытие: 2 мин           │
│ ├─ Комфорт-класс                   │
│ ├─ Кондиционер                     │
│ └─ Wi-Fi в салоне                  │
└─────────────────────────────────────┘
```

## 🔄 Динамическое ценообразование

### **Факторы влияния на цену:**

#### **1. Спрос и предложение:**
```javascript
const demandSupplyRatio = activeRides / availableDrivers

if (demandSupplyRatio > 2.0) {
  multiplier = 1.5  // Высокий спрос
} else if (demandSupplyRatio > 1.5) {
  multiplier = 1.3  // Средний спрос
} else if (demandSupplyRatio > 1.0) {
  multiplier = 1.1  // Небольшой спрос
} else {
  multiplier = 1.0  // Нормальная ситуация
}
```

#### **2. Время суток:**
```javascript
const hourMultipliers = {
  "06:00-09:00": 1.2,  // Утренний час пик
  "09:00-17:00": 1.0,  // Обычное время
  "17:00-20:00": 1.3,  // Вечерний час пик
  "20:00-22:00": 1.1,  // Вечер
  "22:00-06:00": 1.4   // Ночь
}
```

#### **3. День недели:**
```javascript
const dayMultipliers = {
  "monday": 1.0,
  "tuesday": 1.0,
  "wednesday": 1.0,
  "thursday": 1.0,
  "friday": 1.2,      // Пятница
  "saturday": 1.3,    // Суббота
  "sunday": 1.1       // Воскресенье
}
```

#### **4. Погодные условия:**
```javascript
const weatherMultipliers = {
  "clear": 1.0,
  "rain": 1.2,
  "snow": 1.4,
  "storm": 1.6
}
```

#### **5. Местные события:**
```javascript
// Концерты, спортивные события, праздники
const eventMultipliers = {
  "concert": 1.3,
  "football_match": 1.4,
  "new_year": 2.0,
  "midsummer": 1.8
}
```

## 🎛️ Управление тарифами водителем

### **Интерфейс водителя:**
```
┌─────────────────────────────────────┐
│ 💰 Управление тарифами              │
├─────────────────────────────────────┤
│ Базовый тариф (посадка)             │
│ [€2.50] ← → [€3.50]                │
│                                     │
│ Цена за километр                    │
│ [€1.20] ← → [€1.80]                │
│                                     │
│ Цена за минуту                      │
│ [€0.30] ← → [€0.50]                │
│                                     │
│ 🌙 Ночная надбавка                  │
│ [€0.50/км] ← → [€1.00/км]          │
│                                     │
│ 🎉 Выходная надбавка                │
│ [€0.20/км] ← → [€0.40/км]          │
│                                     │
│ ✈️ Аэропорт надбавка                │
│ [€2.00] ← → [€3.00]                │
├─────────────────────────────────────┤
│ 📊 Рекомендации системы:            │
│ • Средний тариф в регионе: €1.35/км │
│ • Ваш рейтинг: 4.8⭐                │
│ • Рекомендуемая цена: €1.25/км     │
├─────────────────────────────────────┤
│ [💾 Сохранить] [🔄 Сбросить]        │
└─────────────────────────────────────┘
```

### **Автоматические рекомендации:**
```javascript
function generateTariffRecommendations(driver) {
  const regionAverage = getRegionAverageTariff(driver.region)
  const driverRating = driver.rating
  const completedTrips = driver.tripsCount
  
  // Водители с высоким рейтингом могут ставить цены выше среднего
  const ratingMultiplier = driverRating >= 4.7 ? 1.1 : 
                          driverRating >= 4.5 ? 1.0 : 0.95
  
  // Опытные водители могут ставить цены выше
  const experienceMultiplier = completedTrips >= 1000 ? 1.05 :
                              completedTrips >= 500 ? 1.0 : 0.98
  
  const recommendedPrice = regionAverage * ratingMultiplier * experienceMultiplier
  
  return {
    recommended: recommendedPrice,
    min: regionAverage * 0.8,
    max: regionAverage * 1.3,
    reasoning: generateReasoningText(ratingMultiplier, experienceMultiplier)
  }
}
```

## 📈 Аналитика и оптимизация

### **Метрики для водителей:**
- **Средняя стоимость поездки** по сравнению с регионом
- **Количество заказов** в зависимости от тарифа
- **Рейтинг клиентов** vs цена
- **Доходность** по часам/дням

### **Метрики для системы:**
- **Время ожидания** клиентов
- **Процент принятых заказов**
- **Средняя стоимость** по регионам
- **Удовлетворенность** клиентов

### **A/B тестирование:**
- Разные алгоритмы сортировки водителей
- Влияние отображения цены на выбор
- Оптимальные множители спроса
- Эффективность рекомендаций тарифов

## 🎯 Выводы

### **Преимущества системы:**
1. **Справедливость** - каждый водитель устанавливает свои цены
2. **Прозрачность** - клиент видит все варианты и детали
3. **Гибкость** - динамическое ценообразование
4. **Конкуренция** - водители конкурируют по цене и качеству
5. **Оптимизация** - система учитывает множество факторов

### **Вызовы:**
1. **Сложность** - много параметров для настройки
2. **Балансировка** - нужно избегать демпинга цен
3. **Обучение** - водители должны понимать систему
4. **Мониторинг** - контроль справедливости алгоритма

### **Следующие шаги:**
1. Реализация алгоритма в коде
2. Создание UI для управления тарифами
3. Тестирование на реальных данных
4. Оптимизация на основе метрик

---

**Эта система обеспечивает справедливое и эффективное распределение заказов, учитывая интересы как водителей, так и клиентов.**

